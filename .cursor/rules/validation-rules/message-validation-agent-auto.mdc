---
description: Message validation agent - validates MaKo messages against schemas, business rules, and EBD validation logic (Conuti)
globs:
  - "**/*.json"
  - "**/*.yaml"
  - "**/*.yml"
  - "backend/**/*"
  - "src/**/*"
  - "api/**/*"
  - "validation/**/*"
  - "test/**/*"
alwaysApply: false
tags: [validation, message, conuti, schema, business-rules, ebd]
priority: 3
version: 1.1.0
---

# Message Validation Agent

## Purpose

Validate MaKo messages before sending to Conuti by checking:
- **Payload validity**: schema (`PI_[ID].yml`) + business rules (`yaml_output/[ID].yaml`)
- **Business validation logic**: EBD (`ebd-diagrams/FV{YYMM}/E_{code}.json`) for validation steps + rejection codes
- **BO4E types**: `bo4e-openapi.min.json`
- **Implementation gaps**: missing handlers/logic (derived from code, not guessed)

## Validation Workflow

### Step 1: Load Process Context (never guess)

1. Identify process ID (BDEW Prüfidentifikator)
2. Use `docs/entry-points/PROCESS_GRAPH.json` for discovery (index-only):
   - Prefer: `indexes.by_bdew_id["[ID]"]`
   - ⚠️ If that key doesn’t exist, inspect `indexes.*` in the actual file and use what’s present.
3. Load payload schema (structure): `maco-api-documentation/macoapp-schreiben/components/requestBodies/PIs/PI_[ID].yml`
4. Load business rules (requiredness/constraints): `maco-api-documentation/pythons/createPiFromTemplater/templater/yaml_output/[ID].yaml`
5. Load BO4E types: `maco-api-documentation/_build/bo4e-openapi.min.json`
6. Load examples (⚠️ ALWAYS use v202510; never v202404):
   - Outbound JSON (what you send): `maco-edi-testfiles/outbound/v202510/{message_type}/[ID]/*.json`
   - Inbound EDI (what you receive): `maco-edi-testfiles/inbound/v202510/{message_type}/[ID]/*.edi`
7. Load EBD (if process docs reference an Entscheidungsbaum):
   - Find code via process docs: `docs-offline/{process}.md` contains `Entscheidungsbaum E_{code}`
   - ⚠️ ALWAYS use newest EBD version folder under `ebd-diagrams/` → `FV{YYMM}/`
   - Read: `ebd-diagrams/FV{YYMM}/E_{code}.json` (preferred); optionally `.dot`/`.svg`

### Step 2: Validate Payload Against Schema (PI_[ID].yml)

- Required fields present
- Types match
- Nested structures valid
- Enum values valid (if applicable)

### Step 3: Validate Payload Against Business Rules (yaml_output/[ID].yaml)

- Mandatory fields
- Constraints (length/pattern/range)
- Conditional rules

### Step 4: Validate Against EBD (E_{code}.json) — if available

Use EBD to understand:
- **Which validations happen** (steps/decision points)
- **Which rejection codes exist** (complete list from EBD)

**Truth precedence**:
- Payload requiredness/structure: **PI + yaml_output wins**
- Validation logic/rejection reasons: **EBD wins**
- If EBD appears to imply a field is required but PI/yaml_output don’t: **report discrepancy**, don’t silently change requiredness.

### Step 5: Check Implementation Gaps (derive from code)

Only report missing functionality if you can cite where it should exist:
- Missing webhook handlers (cite file/path/symbol)
- Missing transformation logic (cite file/path/symbol)
- Missing data availability in code paths (cite actual queries/mappers)

### Step 6: Produce Output (fast-path vs workflow)

**Fast Path (narrow validation request)**: return a compact report (no diagrams required):
- Schema: pass/fail + missing/invalid fields
- Business rules: pass/fail + violations
- EBD: likely rejection codes (only if EBD was read)

**Workflow/process request**: include a Mermaid visualization plus the report.

## Validation Checklist

- [ ] Process ID identified correctly
- [ ] PROCESS_GRAPH.json used for discovery (index-only)
- [ ] PI_[ID].yml validated
- [ ] yaml_output/[ID].yaml validated
- [ ] BO4E types checked (as needed)
- [ ] Examples referenced (⚠️ v202510 only; outbound JSON / inbound EDI)
- [ ] EBD referenced (latest FV folder) when process docs indicate an Entscheidungsbaum exists
- [ ] No endpoints/DB fields “invented” — all implementation gaps are cited from code

<valid-example>
User: "Validate this payload for process 55077"

Agent:
1) Reads `PI_55077.yml` + `yaml_output/55077.yaml`
2) References outbound example in `maco-edi-testfiles/outbound/v202510/.../55077/...`
3) If process docs reference E_0622/E_0623, reads `ebd-diagrams/FV{YYMM}/E_0622.json` and/or `E_0623.json`
4) Returns a compact validation report (no diagram unless requested)
</valid-example>

<invalid-example>
- Claiming rejection codes without reading EBD JSON
- Claiming a REST endpoint exists/missing without reading backend code
- Using v202404 examples
</invalid-example>

