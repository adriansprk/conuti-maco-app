---
description: Message builder agent - pre-creates MaKo messages from available data, validates, and prepares for Conuti testing
globs:
  - "**/*.json"
  - "**/*.yaml"
  - "backend/**/*"
  - "src/**/*"
  - "api/**/*"
  - "builder/**/*"
alwaysApply: false
tags: [builder, message, conuti, pre-create, schema, business-rules, ebd]
priority: 3
version: 1.1.0
---

# Message Builder Agent

## Purpose

Pre-create MaKo messages from available inputs (today: user-provided data; future: DB), by:
- Discovering process requirements (PROCESS_GRAPH → docs → schema/rules/examples)
- Building payloads to match `PI_[ID].yml`
- Applying mandatory fields/constraints from `yaml_output/[ID].yaml`
- Using **v202510 outbound JSON examples** as the realism check
- Surfacing likely rejection risks via **EBD** when applicable

## Message Building Workflow

### Step 1: Identify Process + Sources of Truth

1. User provides BDEW ID or business goal
2. Discover via `docs/entry-points/PROCESS_GRAPH.json` (index-only):
   - Prefer `indexes.by_bdew_id["[ID]"]`
   - ⚠️ If key differs, inspect `indexes.*` in the actual file and use what exists
3. Load schema: `maco-api-documentation/macoapp-schreiben/components/requestBodies/PIs/PI_[ID].yml`
4. Load business rules: `maco-api-documentation/pythons/createPiFromTemplater/templater/yaml_output/[ID].yaml`
5. Load BO4E types: `maco-api-documentation/_build/bo4e-openapi.min.json` (as needed)
6. Load outbound examples (⚠️ ALWAYS v202510): `maco-edi-testfiles/outbound/v202510/{message_type}/[ID]/*.json`

### Step 2: Optional — Pre-flight Validation Risks (EBD)

If process docs mention an Entscheidungsbaum:
- Find EBD code in `docs-offline/{process}.md` (`Entscheidungsbaum E_{code}`)
- Use newest `ebd-diagrams/FV{YYMM}/`
- Read `ebd-diagrams/FV{YYMM}/E_{code}.json`

Use EBD to warn about likely rejection reasons. Do **not** use EBD to invent required fields if PI/yaml_output disagree.

### Step 3: Build Payload

1. Start from schema shape (`PI_[ID].yml`)
2. Populate required fields from inputs (or DB in future)
3. Enforce requiredness/constraints from `yaml_output/[ID].yaml`
4. Cross-check against a v202510 outbound example for the same process ID
5. Keep unknown/optional fields out unless you can justify them via schema/example

### Step 4: Validate (delegate)

Run the validation workflow defined in `message-validation-agent-auto` (schema + yaml_output + EBD + examples).

### Step 5: Output (fast-path vs workflow)

**Fast Path**: If user only wants “build me the payload”, return:
- JSON payload
- A short list of remaining unknown/missing required inputs (with citations to schema/rules)
- A reference to the closest v202510 example file used

**Workflow request**: If user asks for the end-to-end process explanation, add Mermaid diagrams and mapping tables.

## Non-negotiables

- ⚠️ **Never invent** endpoints, DB fields, or payload fields. Everything must come from schema/rules/examples or user-provided data.
- ⚠️ **Always v202510** for testfiles (outbound JSON / inbound EDI).
- If an EBD/PNG file does not exist for a process, state that explicitly.

<valid-example>
User: "Build message for process 55077 using these inputs …"
Agent:
1) Reads `PI_55077.yml` + `yaml_output/55077.yaml`
2) Uses a v202510 outbound example for 55077 as reference
3) Builds payload that matches schema + rules
4) Lists missing required inputs (if any) with citations
</valid-example>

